<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor</title>
    <link rel="icon" href="Icons8-Ios7-Animals-Cat.ico" />
</head>
<body>
    <input type="text" id="sas"/>
    <input type="button" value="Refresh" onclick="refresh()"><br/>
    <div id="videos"></div>

    <script type="text/javascript">

        var storagebaseurl = "https://homecv.blob.core.windows.net/catfeedervideo"
        var videos = document.getElementById("videos")
        var player = document.getElementById("player")
        document.getElementById('sas').value = getCookieValue("sas")

        function refresh() {
            var sas = getSas()
            setCookieValue("sas", sas)
            var xhttp = new XMLHttpRequest();

            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {

                    response = xhttp.responseText

                    var xml = new window.DOMParser().parseFromString(response, "text/xml");

                    var xpathResult = document.evaluate("//Blobs/Blob/Name[contains(text(), '.mp4')]", xml);//, namespaceResolver, resultType, result);

                    videos.innerHTML = "";

                    while(node = xpathResult.iterateNext()) {
                        var name = node.textContent;
                        appendVideo(name)
                    }
                }
            };
            var url = `${storagebaseurl}?restype=container&comp=list&${sas}`
            xhttp.open("GET", url, true);
            xhttp.send();
        }

        function appendVideo(blobName) {
            var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
            var month = blobName.substring(5, 5+2)
            month = months[1 * month - 1]
            var day = blobName.substring(8, 8+2)
            var hour = blobName.substring(20, 20+2)
            var minute = blobName.substring(22, 22+2)
            var name = `${month} ${day} ${hour}:${minute}`

            var sas = getSas()

            var video = document.createElement('div');
            var videoUrl = `${storagebaseurl}/${blobName}?${sas}`;
            var posterUrl = `${storagebaseurl}/${blobName.replace('.mp4', '.jpg')}?${sas}`;
            var html = `
                <video width="640" height="480" controls preload="none" poster="${posterUrl}">
                    <source src="${videoUrl}" type="video/mp4">
                </video><br/>
                <div>${name}</div>
                `;
            video.innerHTML = html
            videos.prepend(video)
        }

        function getSas() {
            var sas = document.getElementById('sas').value
            if (sas.startsWith("?")) {
                sas = sas.substring(1)
            }
            return sas
        }

        function setCookieValue(name, value) {
            value = encodeURIComponent(value)
            var date = new Date();
            date.setTime(date.getTime() + (365*24*60*60*1000)); // 1 year from now
            cookie = `${name}=${(value || "")}; expires=${date.toUTCString()}"; path=/`
            document.cookie = cookie
        }

        function getCookieValue(name) {
            var result = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)')?.pop() || ''
            result = decodeURIComponent(result)
            return result
        }

    </script>
</body>
</html>