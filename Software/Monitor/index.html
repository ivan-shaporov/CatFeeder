<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor</title>
</head>
<body>
    <input type="text" id="sas"/>
    <input type="button" value="Refresh" onclick="refresh()"><br/>
    <div style="height:200px;overflow-y:scroll;">
        <table id="videos"></table>
    </div>
    <video id="player" width="640" height="480" controls>
        Your browser does not support the video tag.
    </video>

    <script type="text/javascript">

        var storagebaseurl = "https://homecv.blob.core.windows.net/catfeedervideo"
        var videos = document.getElementById("videos")
        var player = document.getElementById("player")
        document.getElementById('sas').value = getCookieValue("sas")

        function refresh() {
            var sas = getSas()
            setCookieValue("sas", sas)
            var xhttp = new XMLHttpRequest();

            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {

                    response = xhttp.responseText

                    var xml = new window.DOMParser().parseFromString(response, "text/xml");

                    var xpathResult = document.evaluate("//Blobs/Blob/Name", xml);//, namespaceResolver, resultType, result);

                    videos.innerHTML = "";

                    while(node = xpathResult.iterateNext()) {
                        var name = node.textContent;
                        appendVideo(name)
                    }
                }
            };
            var url = `${storagebaseurl}?restype=container&comp=list&${sas}`
            xhttp.open("GET", url, true);
            xhttp.send();
        }

        function appendVideo(blobName) {
            var row = videos.insertRow(0);
            var cell = row.insertCell(0);

            var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
            var month = blobName.substring(5, 5+2)
            month = months[1 * month - 1]
            var day = blobName.substring(8, 8+2)
            var hour = blobName.substring(20, 20+2)
            var minute = blobName.substring(22, 22+2)

            var sas = getSas()
            var a = document.createElement('a');
            a.innerHTML = `${month} ${day} ${hour}:${minute}`
            a.href = `#`
            a.onclick = () => Play(blobName)
            cell.appendChild(a);
        }

        function Play(blobName) {
            var sas = getSas()
            var videoUrl = `${storagebaseurl}/${blobName}?${sas}`;
            var sources = player.getElementsByTagName('source');

            if (sources.length <= 0) {
                var source = document.createElement("source");
                source.setAttribute("src", videoUrl)
                player.appendChild(source)
            }
            else {
                sources[0].src = videoUrl;
            }
            player.load();
        }

        function getSas() {
            var sas = document.getElementById('sas').value
            if (sas.startsWith("?")) {
                sas = sas.substring(1)
            }
            return sas
        }

        function setCookieValue(name, value) {
            value = encodeURIComponent(value)
            var date = new Date();
            date.setTime(date.getTime() + (365*24*60*60*1000)); // 1 year from now
            cookie = `${name}=${(value || "")}; expires=${date.toUTCString()}"; path=/`
            document.cookie = cookie
        }

        function getCookieValue(name) {
            var result = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)')?.pop() || ''
            result = decodeURIComponent(result)
            return result
        }

    </script>
</body>
</html>